name: "Deploy dwaves-app to GCS"
description: "Deploy dwaves-app to GCS"
runs:
    using: composite
    steps:
      - name: GCP authentification ü§ë
        uses: google-github-actions/setup-gcloud@v0
        with:
          service_account_key: ${{ env.GCP_SA_KEY }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Retrieve environment variables üåé
        working-directory:  ${{ env.PROJECT_DIRECTORY }}
        shell: bash
        run: |-
          source ${{ env.PROPERTIES_SCRIPT }} && doppler_setup

      - name: NPM install
        working-directory:  ${{ env.PROJECT_DIRECTORY }}
        shell: bash
        run: |-
          npm install

      - name: Build üèó
        working-directory:  ${{ env.PROJECT_DIRECTORY }}
        shell: bash
        run: |-
          CI="false" npm run deploy-build

      - name: Deploy  üöÄ
        working-directory:  ${{ env.PROJECT_DIRECTORY }}
        shell: bash
        run: |-
          source ${{ env.PROPERTIES_SCRIPT }} && doppler_setup
          export gcp_environment="${{ env.APP }}-$ENVIRONMENT"
          export deploy_url=$BUCKET_NAME
          gsutil rsync -R build/ gs://$deploy_url
          echo "Deployed to $gcp_environment environment: $deploy_url"