name: web Deployment

on:
  push:
    branches: 
      - staging
      - feature/*
  pull_request:
    branches: [ staging ]

env:
  PROJECT_ID: ${{ secrets.DWAVES_PROJECT_ID }}

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16.x]
    environment: staging 
    steps:

    - name: Trigger Message 📥
      run: |-
        echo " The job was automatically triggered by a ${{ github.event_name }} event."
        echo "This job is now running on a ${{ runner.os }} server hosted by GitHub!"
        echo "The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."

    - name: Checkout 😇
      uses: actions/checkout@v3

    # Setup gcloud CLI
    - name: GCLOUD authentification 🤑
      uses: google-github-actions/setup-gcloud@v0.2.0
      with:
        service_account_key: ${{ secrets.TF_SA }}
        project_id: ${{ secrets.DWAVES_PROJECT_ID }}

    # Build npm
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
          node-version: ${{ matrix.node-version }}

    - name: Build 🏗
      working-directory: ./frontend/dwaves-player
      run: |-
        ls ${{ github.workspace }}
        npm ci
        npm run build --if-present --production

    - name: Test 🧪
      run: |-
        echo "It is la rue bro, there is no test here. Just pass your way 😏"

    # Deploy
    # - name: Deploy 🛫
    #   uses: 'google-github-actions/upload-cloud-storage@v0'
    #   with:
    #     path: '${{ github.workspace }}/out/'
    #     destination: '${{secrets.DWAVES_STAGING_BUCKET}}'
        # gsutil rsync -R local-dir gs://www.cookingincloudhipster.com

    - name: deploy 🧪
      working-directory: ./frontend/dwaves-player
      run: |-
        gsutil rsync -R /dist/ gs://dwaves-staging.tonfrere.fr

    # Cleanup
    - name: Cleanup 🚿
      run: |-
        echo "🎉 This job's status is ${{ job.status }}."