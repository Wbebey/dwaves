name: Staging Deployment

on:
  push:
    branches: 
      - staging
      # - feature/*

env:
  PROJECT_ID: ${{ secrets.DWAVES_PROJECT_ID }}

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16.x]
    environment: staging 
    steps:

    - name: Trigger Message ğŸ“¥
      run: |-
        echo " The job was automatically triggered by a ${{ github.event_name }} event."
        echo "This job is now running on a ${{ runner.os }} server hosted by GitHub!"
        echo "The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."

    - name: Checkout ğŸ˜‡
      uses: actions/checkout@v3

    # Setup gcloud CLI
    - name: GCLOUD authentification ğŸ¤‘
      uses: google-github-actions/setup-gcloud@v0.2.0
      with:
        service_account_key: ${{ secrets.TF_SA }}
        project_id: ${{ secrets.DWAVES_PROJECT_ID }}

    # Build npm
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
          node-version: ${{ matrix.node-version }}

    - name: Environment variables ğŸ§ª
      working-directory: ./frontend/dwaves-player
      run: |-
        sed -i 's/localhost:3000/${{ secrets.STAGING_ADDRESS }}/g' src/Pages/Player.tsx

    - name: Build ğŸ—
      working-directory: ./frontend/dwaves-player
      run: |-
        ls ${{ github.workspace }}
        npm install
        CI='false' npm run build 


    # Deploy
    # - name: Deploy ğŸ›«
    #   uses: 'google-github-actions/upload-cloud-storage@v0'
    #   with:
    #     path: '${{ github.workspace }}/out/'
    #     destination: '${{secrets.DWAVES_STAGING_BUCKET}}'
    #   run: |-
    #     gsutil rsync -R local-dir gs://www.cookingincloudhipster.com

    - name: deploy ğŸ§ª
      working-directory: ./frontend/dwaves-player
      run: |-
        gsutil rsync -R build/ gs://${{ secrets.STAGING_ADDRESS }}

    # Cleanup
    - name: Cleanup ğŸš¿
      run: |-
        echo "ğŸ‰ This job's status is ${{ job.status }}."